<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Entity Framework Conventions : " />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Entity Framework Conventions</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/Grinderofl/EFConvention">View on GitHub</a>

          <h1 id="project_title">Entity Framework Conventions</h1>
          <h2 id="project_tagline"></h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/Grinderofl/EFConvention/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/Grinderofl/EFConvention/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="efconvention" class="anchor" href="#efconvention"><span class="octicon octicon-link"></span></a>EFConvention</h1>

<p>EFConvention is a convention based extension library for Entity Framework to automate several tasks currently cumbersome to do. It allows developers to create an Entity Framework based Context without having to specify each entity by putting it as DbSet&lt;&gt; as property. </p>

<p>NuGet: <a href="http://www.nuget.org/packages/EFConvention/">http://www.nuget.org/packages/EFConvention/</a></p>

<h1>
<a name="basic-usage" class="anchor" href="#basic-usage"><span class="octicon octicon-link"></span></a>Basic usage</h1>

<p>1) Create the context factory</p>

<div class="highlight highlight-c#"><pre><span class="k">private</span> <span class="n">IAutoContextFactory</span> <span class="n">_autoContextFactory</span><span class="p">;</span>
<span class="n">_autoContextFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoContextFactory</span><span class="p">();</span>
<span class="n">_autoContextFactory</span><span class="p">.</span><span class="n">AddEntitiesBasedOn</span><span class="p">&lt;</span><span class="n">BaseEntity</span><span class="p">&gt;().</span><span class="n">AddAssemblyContaining</span><span class="p">&lt;</span><span class="n">BaseEntity</span><span class="p">&gt;();</span>
</pre></div>

<p>2) Configure the factory</p>

<p>a) Use context factory configuration:</p>

<div class="highlight highlight-c#"><pre><span class="n">_autoContextFactory</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">AutoGeneratedMigrationsEnabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span> 
<span class="n">_autoContextFactory</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">AutoMigrateGeneratedMigrationsEnabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="n">_autoContextFactory</span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">MigrationsDirectory</span> <span class="p">=</span> <span class="s">@"ProjectDir\Migrations"</span><span class="p">;</span>
</pre></div>

<p>b) Or use conventions:</p>

<div class="highlight highlight-c#"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">ConventionConfiguration</span> <span class="p">:</span> <span class="n">IEFConventionConfigurator</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IAutoContextFactoryConfiguration</span> <span class="n">configuration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">configuration</span><span class="p">.</span><span class="n">AutoGeneratedMigrationsEnabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">configuration</span><span class="p">.</span><span class="n">AutoMigrateGeneratedMigrationsEnabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">configuration</span><span class="p">.</span><span class="n">MigrationsDirectory</span> <span class="p">=</span> <span class="s">@"ProjectDir\Migrations\"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>3) Create the context and use it</p>

<div class="highlight highlight-c#"><pre><span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">_autoContextFactory</span><span class="p">.</span><span class="n">Context</span><span class="p">();</span>
<span class="n">context</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;().</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Item</span><span class="p">());</span>
<span class="n">context</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
</pre></div>

<h1>
<a name="detailed-info" class="anchor" href="#detailed-info"><span class="octicon octicon-link"></span></a>Detailed info</h1>

<h3>
<a name="lifecycle" class="anchor" href="#lifecycle"><span class="octicon octicon-link"></span></a>Lifecycle</h3>

<p>Factory lifecyle should be same as your application lifecycle. First Context() call checks if database has already been migrated, provided AutoMigrateGeneratedMigrationsEnabled is set to true. If you manage migrations manually, lifecycle can be anything and you will be responsible for performance and errors. DbContext lifecycle can be anything you would normally set a standard DbContext to, in Web cases it would be per Request.</p>

<h3>
<a name="context" class="anchor" href="#context"><span class="octicon octicon-link"></span></a>Context</h3>

<p>From versioni 2.4, EFConvention uses a standard DbContext. Use the Context() call as such.</p>

<p>Context() call from Factory also accepts a string parameter for connection string, either full connectionstring or the name of it, just like standard DbContext. It's suggested to just set the Connection option under Configuration property, though.</p>

<h3>
<a name="configuration" class="anchor" href="#configuration"><span class="octicon octicon-link"></span></a>Configuration</h3>

<p><strong>IAutoContextFactoryConfiguration</strong> provides several configuration options. </p>

<ul>
<li><p><strong>MigrationsDirectory</strong> - where you want the program to store its migration files. The files are standard Code First Migration files. This directory should be included in your source control to allow synchronized migrations between developers.</p></li>
<li><p><strong>AutomaticMigrationsEnabled</strong> - this is an option normally used in standard Code First Migration Configuration as <em>AutomaticMigrationsEnabled</em>, having this option on disables the Code Based migration generation.</p></li>
<li><p><strong>AutomaticMigrationDataLossAllowed</strong> - goes together with AutoMigrateToLatestVersionEnabled, allows data loss on automatic migrations.</p></li>
<li><p><strong>AutoGeneratedMigrationsEnabled</strong> - option used to specify that, if model has changed, a new migration should be generated. This option exists so programmatic migration generation through Factory could be used.</p></li>
<li><p><strong>AutoMigrateGeneratedMigrationsEnabled</strong> - option used to specify whether, if model has changed, newly generated migrations should be migrated to database. If this feature is disabled, migrations need to be done programmatically through Factory. If AutoGeneratedMigrationsEnabled is set to false, migrations need to be generated programmatically or migrations will fail.</p></li>
<li><p><strong>Connection</strong> - your standard connectionstring or connectionstring name</p></li>
<li><p><strong>MigrationsAssemblyAsFile</strong> - option used if you want migrations to be compiled into a file or loaded from an existing file. Useful if you want to deploy your application but not distribute the .cs  files. Make sure to set the file name.</p></li>
<li><p><strong>MigrationsAssemblyFileLocation</strong> - name of the file the compiled migration assembly should be saved to. Only functions when MigrationsAssemblyAsFile is true.</p></li>
</ul><p><strong>NB! Order of operations is important. Any configuration should be done before Context(), MigrateToLatest() or GenerateMigrations() are called for the first time on Factory, although before migrating, anything ought to work.</strong></p>

<h3>
<a name="factory" class="anchor" href="#factory"><span class="octicon octicon-link"></span></a>Factory</h3>

<ul>
<li><p><strong>Configuration</strong> - IAutoContextFactoryConfiguration for configuring the factory</p></li>
<li><p><strong>AddEntitiesBasedOn&lt;T&gt;()</strong> - This method allows convention based adding of entities to the context. All entities that are not abstract and are based on this class (or these classes, if you add more than one) are automatically added. Assemblies to be searched from also needs to be added.</p></li>
<li><p><strong>AddEntity&lt;T&gt;()</strong> - Adds a single entity to context.</p></li>
<li><p><strong>AddAssemblyContaining&lt;T&gt;()</strong> - Adds an assembly which should be searched for convention added classes, which contains specified class.</p></li>
</ul><div class="highlight highlight-c#"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">EntityBase</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">EntityOne</span> <span class="p">:</span> <span class="n">EntityBase</span> <span class="p">{}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">EntityTwo</span> <span class="p">:</span> <span class="n">EntityBase</span> <span class="p">{}</span>

<span class="n">factory</span><span class="p">.</span><span class="n">AddEntitiesBasedOn</span><span class="p">&lt;</span><span class="n">EntityBase</span><span class="p">&gt;().</span><span class="n">AddAssemblyContaining</span><span class="p">&lt;</span><span class="n">EntityOne</span><span class="p">&gt;();</span> 
<span class="c1">// Adds EntityOne and EntityTwo to context</span>
</pre></div>

<ul>
<li><p><strong>AddAssembly(Assembly assembly)</strong> - Adds a single assembly that should be searched for convention-added classes.</p></li>
<li><p><strong>Context()</strong> - Retrieves the context (and also causes it to be generated if it hasn't yet). If AutoMigrateGeneratedMigrationsEnabled is true, migrations are also run.</p></li>
<li><p><strong>MigrateToLatest()</strong> - Migrates the database to latest version (and also causes context to be generated if it hasn't yet). If AutoGeneratedMigrationsEnabled is true, missing migrations are automatically generated.</p></li>
<li><p><strong>GenerateMigrations()</strong> - Generates migrations and saves them under specified migrations directory (and also causes context to be generated if it hasn't yet). <em>Does not automatically migrate</em>.</p></li>
<li><p><strong>IncludedTypes()</strong> - Returns a list of types currently included in the context.</p></li>
<li>
<strong>AssembliesThatContain()</strong> - Returns a list of assemblies that should be searched.</li>
<li>
<strong>Entities()</strong> - Returns a list of types that are single included in context.</li>
<li>
<strong>EntitiesToBaseOn()</strong> - Returns a list of base types to be used for searching.</li>
</ul><p><strong>NB! Order of operations is important. Any other method should be called before Context(), MigratToLatest() or GenerateMigrations() are called for the first time on Factory</strong> </p>

<h1>
<a name="model-builder-conventions" class="anchor" href="#model-builder-conventions"><span class="octicon octicon-link"></span></a>Model Builder Conventions</h1>

<p>Starting from version 2.1, EFConvention supports NHibernate-style convention based model building. These classes are IModelBuilderOverride type and take an entity that you wish to map as a generic argument. They will be automatically picked up as long as they're in one of the assemblies you added using <code>AddAssemblyContaining&lt;T&gt;()</code> or <code>AddAssembly(Assembly assembly)</code></p>

<div class="highlight highlight-c#"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">ItemOverride</span> <span class="p">:</span> <span class="n">IModelBuilderOverride</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">EntityTypeConfiguration</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;</span> <span class="n">entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">entity</span><span class="p">.</span><span class="n">ToTable</span><span class="p">(</span><span class="s">"MyTable"</span><span class="p">);</span>
        <span class="c1">// Insert your mapping code here</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h1>
<a name="listener-conventions" class="anchor" href="#listener-conventions"><span class="octicon octicon-link"></span></a>Listener Conventions</h1>

<p>Starting from version 2.1, EFConvention also supports NHibernate style event listeners that can be hooked to different types of events in both pre and post save. Those, too, will be picked up automatically as long as they are located within the assmblies to be searched for items. Full list can be found under <code>EFConvention.Interceptors</code> namespace. The <code>IPreEventListener</code> and <code>IPostEventListener</code> react to any type of entity state.</p>

<div class="highlight highlight-c#"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">MyEventListener</span> <span class="p">:</span> <span class="n">IPreInsertEventListener</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">OnInsert</span><span class="p">(</span><span class="n">DbEntityEntry</span> <span class="n">entityEntry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">entityEntry</span><span class="p">.</span><span class="n">Entity</span> <span class="k">is</span> <span class="n">BaseEntity</span><span class="p">)</span>
            <span class="p">((</span><span class="n">BaseEntity</span><span class="p">)</span><span class="n">entityEntry</span><span class="p">.</span><span class="n">Entity</span><span class="p">).</span><span class="n">Created</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h1>
<a name="configuration-conventions" class="anchor" href="#configuration-conventions"><span class="octicon octicon-link"></span></a>Configuration conventions</h1>

<p>Starting from version 2.3, EFConvention has a support for automatic EFConvention configuration. Simply create a class that inherits from <code>IEFConventionConfigurator</code> and either stick it into an assembly that you have added via fluent setup and you're good to go:</p>

<div class="highlight highlight-c#"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">ConventionConfiguration</span> <span class="p">:</span> <span class="n">IEFConventionConfigurator</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IAutoContextFactoryConfiguration</span> <span class="n">configuration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">configuration</span><span class="p">.</span><span class="n">AutoGeneratedMigrationsEnabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">configuration</span><span class="p">.</span><span class="n">AutoMigrateGeneratedMigrationsEnabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">configuration</span><span class="p">.</span><span class="n">MigrationsDirectory</span> <span class="p">=</span> <span class="s">@"ProjectDir\Migrations\"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The alternative is, of course, to just configure it when you're setting up your context, such as in Resolve(Component.For()) for Windsor or kernel.Bind() for Ninject.</p>

<h1>
<a name="seeding-conventions" class="anchor" href="#seeding-conventions"><span class="octicon octicon-link"></span></a>Seeding conventions</h1>

<p>Starting from version 2.3, EFConvention also has a support for loading seeding via conventions. EFConvention supports two types of seeding (both can be used concurrently) and as long as they are included in the assembly list, they will be picked up:</p>

<ul>
<li>
<code>IEntitySeed&lt;T&gt;</code> - used to seed a single entity. It provides you with a DbSet for this specific object</li>
</ul><div class="highlight highlight-c#"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">ItemSeed</span> <span class="p">:</span> <span class="n">IEntitySeed</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Seed</span><span class="p">(</span><span class="n">DbSet</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;</span> <span class="n">entity</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">entity</span><span class="p">.</span><span class="n">AddOrUpdate</span><span class="p">(</span><span class="n">a</span> <span class="p">=&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">Data</span><span class="p">,</span> <span class="k">new</span> <span class="n">Item</span><span class="p">()</span> <span class="p">{</span><span class="n">Data</span> <span class="p">=</span> <span class="s">"Hello world"</span><span class="p">,</span> <span class="n">Created</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<ul>
<li>
<code>IContextSeed</code> - provides you with the entire DbContext to use.</li>
</ul><div class="highlight highlight-c#"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">AllSeed</span> <span class="p">:</span> <span class="n">IContextSeed</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Seed</span><span class="p">(</span><span class="n">DbContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">EntityTwo</span><span class="p">&gt;().</span><span class="n">AddOrUpdate</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="k">new</span> <span class="n">EntityTwo</span><span class="p">()</span> <span class="p">{</span><span class="n">Name</span> <span class="p">=</span> <span class="s">"My entity"</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h1>
<a name="events" class="anchor" href="#events"><span class="octicon octicon-link"></span></a>Events</h1>

<p><strong>All events fire before their original base events</strong></p>

<h3>
<a name="icontext-events" class="anchor" href="#icontext-events"><span class="octicon octicon-link"></span></a>IContext Events</h3>

<p>As of version 2.4, IContext has been removed in favor of standard DbContext. </p>

<h3>
<a name="iautocontextfactory-events" class="anchor" href="#iautocontextfactory-events"><span class="octicon octicon-link"></span></a>IAutoContextFactory Events</h3>

<ul>
<li>Seeding - executed when database is seeded. Put your AddOrUpdate events here.</li>
</ul><div class="highlight highlight-c#"><pre><span class="n">factory</span><span class="p">.</span><span class="n">Seeding</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="n">args</span><span class="p">.</span><span class="n">Context</span><span class="p">.(...);</span> <span class="cm">/* args.Context is DbContext */</span> <span class="p">};</span>
</pre></div>

<ul>
<li>ModelCreating - executed when model is being created. Conventions should be set up here.</li>
</ul><div class="highlight highlight-c#"><pre><span class="n">context</span><span class="p">.</span><span class="n">ModelCreating</span> <span class="p">+=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="n">args</span><span class="p">.</span><span class="n">ModelBuilder</span><span class="p">.(...);</span><span class="cm">/* args.ModelBuilder is standard DbModelBuilder */</span><span class="p">};</span>
</pre></div>

<h1>
<a name="version-history" class="anchor" href="#version-history"><span class="octicon octicon-link"></span></a>Version history</h1>

<h5>
<a name="v-240" class="anchor" href="#v-240"><span class="octicon octicon-link"></span></a>v 2.4.0</h5>

<ul>
<li>Removed IContext interface as it has lost its purpose now that T4 context generation is gone. Use standard DbContext type instead.</li>
</ul><h4>
<a name="v-234" class="anchor" href="#v-234"><span class="octicon octicon-link"></span></a>v 2.3.4</h4>

<ul>
<li>Fixed several bugs, such as one that would keep checking database for migrations every time context was requested.</li>
</ul><h4>
<a name="v-23" class="anchor" href="#v-23"><span class="octicon octicon-link"></span></a>v 2.3</h4>

<ul>
<li>Added convention-based configuration.</li>
<li>Added support for convention-based seeding</li>
</ul><h4>
<a name="v-22" class="anchor" href="#v-22"><span class="octicon octicon-link"></span></a>v 2.2</h4>

<ul>
<li>IDbInterceptor-inherited entities are automatically picked up as a convention.</li>
</ul><h4>
<a name="v-21" class="anchor" href="#v-21"><span class="octicon octicon-link"></span></a>v 2.1</h4>

<ul>
<li>Renamed project to EFConventions and then to EFConvention because EFConventions was already taken on NuGet...</li>
<li>Added real convention based model builder overrides.</li>
<li>Added convention based event listeners for post- and pre save states.</li>
</ul><h4>
<a name="v-20" class="anchor" href="#v-20"><span class="octicon octicon-link"></span></a>v 2.0</h4>

<ul>
<li>Complete rework of migrations and context generation. Now using Reflection instead of T4, allowing the runtime injection of ModelCreating object which wasn't working in version 1.</li>
<li>Added support for retrieving currently stored entities, base entities and assemblies for Context generation.</li>
</ul><h4>
<a name="v-103" class="anchor" href="#v-103"><span class="octicon octicon-link"></span></a>v 1.0.3</h4>

<ul>
<li>Context() now accepts a connectionString parameter</li>
</ul><h4>
<a name="v-102" class="anchor" href="#v-102"><span class="octicon octicon-link"></span></a>v 1.0.2</h4>

<ul>
<li>Context() now has its own lifecycle.</li>
</ul><h4>
<a name="v-101" class="anchor" href="#v-101"><span class="octicon octicon-link"></span></a>v 1.0.1</h4>

<ul>
<li>Added IncludedTypes() to Factory</li>
</ul><h4>
<a name="v-10" class="anchor" href="#v-10"><span class="octicon octicon-link"></span></a>v 1.0</h4>

<ul>
<li>Initial release.</li>
</ul><h1>
<a name="todo" class="anchor" href="#todo"><span class="octicon octicon-link"></span></a>TODO</h1>

<ul>
<li>Perhaps give separate events for async savechanges?</li>
<li>Add Identity support.</li>
</ul><h1>
<a name="known-bugs" class="anchor" href="#known-bugs"><span class="octicon octicon-link"></span></a>Known bugs</h1>

<ul>
<li>Might have random file access errors.</li>
</ul>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Entity Framework Conventions maintained by <a href="https://github.com/Grinderofl">Grinderofl</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
